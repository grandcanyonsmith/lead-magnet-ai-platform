name: Deploy API Lambda

on:
  push:
    branches:
      - main
    paths:
      - 'backend/api/**'
      - '.github/workflows/api-deploy.yml'
  pull_request:
    paths:
      - 'backend/api/**'
      - '.github/workflows/api-deploy.yml'
  workflow_dispatch:

concurrency:
  group: api-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: ./.github/actions/setup-node-app
        with:
          node-version: '20'
          working-directory: '.'
      
      - name: Security Audit
        run: npm audit --audit-level=high --workspace backend/api || echo "Audit failed but proceeding (non-blocking for now)"

      - name: Lint
        working-directory: backend/api
        run: npm run lint
      
      - name: Unit tests
        working-directory: backend/api
        run: npm test
      
      - name: Package Lambda
        working-directory: backend/api
        run: npm run package:lambda
      
      - name: Upload Lambda Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-bundle
          path: backend/api/api-bundle.zip
          retention-days: 1

  deploy:
    needs: build_and_test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda Artifact
        uses: actions/download-artifact@v4
        with:
          name: api-bundle
          path: backend/api
      
      - name: Configure AWS credentials
        uses: ./.github/actions/setup-aws
        with:
          role-arn: ${{ env.AWS_ROLE_ARN }}
          access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          region: ${{ env.AWS_REGION }}
      
      - name: Deploy to Lambda
        working-directory: backend/api
        run: |
          if [ ! -f "api-bundle.zip" ]; then
            echo "Error: api-bundle.zip not found."
            exit 1
          fi
          aws lambda update-function-code \
            --function-name leadmagnet-api-handler \
            --zip-file fileb://api-bundle.zip \
            --region ${{ env.AWS_REGION }}
          
          # Optional: Wait for update to be successful
          aws lambda wait function-updated --function-name leadmagnet-api-handler --region ${{ env.AWS_REGION }}
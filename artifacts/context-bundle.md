# Repository Context Bundle

_Generated: 2025-12-03T20:59:20.606Z_

## Repo Map

# Repository Map

Last updated: 2025-12-02 (keep in sync when directories move or teams change).

## Directory Overview

| Path | Owner | Purpose | Entry points & hot spots |
| --- | --- | --- | --- |
| `backend/api` | Backend/API Guild | TypeScript Fastify API serving workflow + form endpoints. | `src/index.ts` bootstraps Fastify, `src/routes/index.ts` wires controllers, `src/services/workflow/*` owns AI + workflow orchestration logic, `src/utils/*.ts` houses shared helpers, `test-local.ts` boots a local server. |
| `backend/worker` | Workflow Automation Guild | Python worker/lambda that executes workflow jobs generated by the API. | `worker.py` (local entry), `lambda_handler.py` (AWS), `processor.py` orchestrates steps, `services/*.py` implement per-step tooling, `tests/test_*.py` cover e2e + unit flows. |
| `frontend` | Frontend Guild | Next.js dashboard + authoring UI for workflows, jobs, and settings. | `src/app` routes (App Router), `src/components` shared UI, `src/api` TS clients, `e2e/` Playwright specs, `next.config.js` + `tailwind.config.ts` for build tooling. |
| `infrastructure` | Platform/Infra Guild | AWS CDK stacks for API, worker, storage, monitoring, and auth. | `bin/app.ts` entry, `lib/*-stack.ts` define stacks, `lib/stepfunctions/job-processor-state-machine.ts` codifies workflow orchestration, `package.json` scripts run `cdk synth/deploy`. |
| `scripts` | Developer Productivity Guild | Operational + debugging scripts for jobs, deployments, artifact sync, and QA. | `deployment/` ship pipeline scripts, `jobs/` CLI helpers for job lifecycle, `testing/` automation harnesses, `lib/common.*` shared helpers. |
| `docs` | Enablement Guild | Living knowledge base for architecture, testing, deployment, and glossary. | `ARCHITECTURE.md`, `LOCAL_DEVELOPMENT.md`, `WEBHOOK_*` guides, `archive/` for retired initiatives, this `repo-map.md` for navigation. |
| `.github` | Platform/Infra Guild | GitHub Actions workflows for API deploys, CDK infra, frontend deploys, worker image builds. | `workflows/*.yml` (deploy + CI jobs). |
| `assets` | Product/Design Guild | Reference imagery for docs, dashboards, and release notes. | `.png` screenshots referenced by README/docs. |
| `plans` | PMO / Tech Leads | In-flight architecture & refactor plans authored for coordination. | `*.plan.md` canonicalizes goals; keep aligned with roadmap docs. |
| Root files (`*.md`, `*.sh`, `*.py`) | Shared | Operational entry points that do not fit into subprojects. | `deploy-*.sh`, `mrr.py`, `uv.lock`, etc. (testing docs now live under `docs/testing/`). |

## Legacy / Follow-Up Areas

- `backend/api/src/utils/` still centralizes generic helpers, but domain-specific workflow prompt/config utilities already moved under `src/services/workflow/`. Prefer importing from the service layer to avoid reintroducing tight couplings.
- `docs/archive/` retains historical refactor plans; migrate active items into `docs/` proper before editing so AI agents do not surface stale instructions.
- `scripts/` contains several near-duplicate job inspection utilities; consolidate around `scripts/jobs/*.py` variants when authoring new automation to keep the context footprint manageable.

## Usage Notes

1. When onboarding humans or AI agents, start with this map → jump to `docs/ARCHITECTURE.md` → open the relevant guild directory.
2. When moving files, update this map in the same PR so CI and assistants stay aware of the new ownership boundaries.
3. If a directory is deprecated or merged, log it in **Legacy / Follow-Up Areas** until fully removed.

## API Contracts

# API Contracts

This directory provides a human-readable contract for the REST API that powers the lead magnet platform.  
It is the authoritative reference for AI assistants and engineers when wiring new features or debugging client calls.

## Base URL & Auth

- **Base URL:** `https://czp5b77azd.execute-api.us-east-1.amazonaws.com`
- **Stage:** All documented endpoints live under the default stage (`/`), so paths below are absolute.
- **Auth:** Every `/admin/*` route requires a Cognito JWT attached as `Authorization: Bearer <token>` plus the contextual headers inserted by `frontend/src/lib/api/base.client.ts`.
- **Tenancy:** `router.register` injects the tenant/customer context from the auth token; no manual tenant headers are needed unless you impersonate.

## Domain Overview

| Domain | Routes File | Controllers | Frontend Client |
| --- | --- | --- | --- |
| Workflows | `backend/api/src/domains/workflows/routes/workflowRoutes.ts` | `workflowsController`, `workflowAIController`, `workflowValidationController` | `frontend/src/lib/api/workflows.client.ts` |
| Forms | `backend/api/src/domains/forms/routes/formRoutes.ts` & `backend/api/src/routes/publicRoutes.ts` | `formsController`, `formAIController` | `frontend/src/lib/api/forms.client.ts` |
| Jobs & Execution | `backend/api/src/routes/jobRoutes.ts` | `jobsController`, `executionStepsController`, `jobRerunController` | `frontend/src/lib/api/jobs.client.ts` |
| Templates | `backend/api/src/routes/templateRoutes.ts` | `templatesController` | `frontend/src/lib/api/templates.client.ts` |
| Notifications | `backend/api/src/routes/adminRoutes.ts` | `notificationsController` | `frontend/src/lib/api/notifications.client.ts` |
| Settings & Analytics | `backend/api/src/routes/settings.ts`, `routes/adminRoutes.ts` | `settingsController`, `analyticsController` | `frontend/src/lib/api/settings.client.ts`, `analytics.client.ts` |
| Webhook Logs | `backend/api/src/routes/webhookRoutes.ts` | `webhookLogsController` | `frontend/src/lib/api/webhookLogs.client.ts` |

The companion machine-readable mapping that ties these endpoints to request/response types lives in `frontend/src/lib/api/contracts.ts`.

## Workflows

| Method & Path | Description | Handler | Client |
| --- | --- | --- | --- |
| `GET /admin/workflows` | List workflows for the authenticated tenant (supports `status`, `limit` query params). | `workflowsController.list` | `WorkflowsClient.getWorkflows` |
| `POST /admin/workflows` | Create a workflow draft with validated steps. | `workflowsController.create` | `WorkflowsClient.createWorkflow` |
| `GET /admin/workflows/:id` | Fetch a workflow with current form metadata. | `workflowsController.get` | `WorkflowsClient.getWorkflow` |
| `PUT /admin/workflows/:id` | Update workflow metadata or steps. | `workflowsController.update` | `WorkflowsClient.updateWorkflow` |
| `DELETE /admin/workflows/:id` | Soft-delete a workflow. | `workflowsController.delete` | `WorkflowsClient.deleteWorkflow` |
| `POST /admin/workflows/generate-with-ai` | Launch asynchronous workflow generation (returns job id). | `workflowAIController.generateWithAI` | `WorkflowsClient.generateWorkflowWithAI` |
| `GET /admin/workflows/generation-status/:jobId` | Poll workflow generation job status. | `workflowAIController.getGenerationStatus` | `WorkflowsClient.getWorkflowGenerationStatus` |
| `POST /admin/workflows/:id/ai-step` | Generate or update a specific step with AI assistance. | `workflowAIController.aiGenerateStep` | `WorkflowsClient.generateStepWithAI` |
| `POST /admin/workflows/:id/ai-edit` | Ask AI to edit an entire workflow. | `workflowAIController.aiEditWorkflow` | `WorkflowsClient.editWorkflowWithAI` |
| `POST /admin/workflows/refine-instructions` | Refine workflow instructions globally. | `workflowAIController.refineInstructions` | `WorkflowsClient.refineInstructions` |

## Forms

| Method & Path | Description | Handler | Client |
| --- | --- | --- | --- |
| `GET /admin/forms` | List admin forms (`limit` query supported). | `formsController.list` | `FormsClient.getForms` |
| `POST /admin/forms` | Create a form bound to a workflow. | `formsController.create` | `FormsClient.createForm` |
| `GET /admin/forms/:id` | Fetch a form (tenant scoped). | `formsController.get` | `FormsClient.getForm` |
| `PUT /admin/forms/:id` | Update a form, including schema and rate limits. | `formsController.update` | `FormsClient.updateForm` |
| `DELETE /admin/forms/:id` | Soft delete a form (only allowed when detached). | `formsController.delete` | `FormsClient.deleteForm` |
| `POST /admin/forms/generate-css` | Generate CSS via AI. | `formAIController.generateCSS` | `FormsClient.generateFormCSS` |
| `POST /admin/forms/refine-css` | Refine CSS via AI. | `formAIController.refineCSS` | `FormsClient.refineFormCSS` |
| `GET /v1/forms/:slug` | Public form definition fetch (no auth). | `formsController.getPublicForm` via `publicRoutes` | `FormsClient.getPublicForm` |
| `POST /v1/forms/:slug/submit` | Public form submission, triggers workflow job. | `formsController.submitForm` via `publicRoutes` | `FormsClient.submitPublicForm` |

## Jobs & Execution

| Method & Path | Description | Handler | Client |
| --- | --- | --- | --- |
| `GET /admin/jobs` | List jobs (`status`, `workflow_id`, pagination` supported). | `jobsController.list` | `JobsClient.getJobs` |
| `GET /admin/jobs/:id` | Fetch a single job with execution status. | `jobsController.get` | `JobsClient.getJob` |
| `POST /admin/jobs/:id/resubmit` | Resubmit a failed job. | `jobsController.resubmit` | `JobsClient.resubmitJob` |
| `POST /admin/jobs/:id/rerun-step` | Re-run a specific execution step. | `jobRerunController.rerunStep` | `JobsClient.rerunStep` |
| `POST /admin/jobs/:id/quick-edit-step` | Quick edit a step output with AI. | `executionStepsController.quickEditStep` | `JobsClient.quickEditStep` |
| `GET /admin/jobs/:id/document` | Fetch rendered document (HTML/Markdown). | `jobsController.getDocument` | `JobsClient.getJobDocument` |
| `GET /admin/jobs/:id/execution-steps` | Fetch execution step metadata/logs. | `executionStepsController.getExecutionSteps` | `JobsClient.getExecutionSteps` |

## Templates & Notifications (Snapshot)

| Method & Path | Description | Handler | Client |
| --- | --- | --- | --- |
| `GET /admin/templates` | List HTML/asset templates. | `templatesController.list` | `TemplatesClient.getTemplates` |
| `POST /admin/templates` | Create template. | `templatesController.create` | `TemplatesClient.createTemplate` |
| `POST /admin/templates/generate-with-ai` | AI-generate template HTML. | `templatesController.generateWithAI` | `TemplatesClient.generateTemplateWithAI` |
| `GET /admin/notifications` | List notifications (optional `unreadOnly`). | `notificationsController.list` | `NotificationsClient.getNotifications` |
| `POST /admin/notifications/:id/mark-read` | Mark a notification as read. | `notificationsController.markRead` | `NotificationsClient.markNotificationRead` |

## Settings & Analytics (Snapshot)

| Method & Path | Description | Handler | Client |
| --- | --- | --- | --- |
| `GET /admin/settings` | Fetch tenant settings & onboarding info. | `settingsController.getSettings` | `SettingsClient.getSettings` |
| `PUT /admin/settings` | Update general branding/delivery settings. | `settingsController.updateSettings` | `SettingsClient.updateSettings` |
| `POST /admin/settings/onboarding-survey` | Persist onboarding survey. | `settingsController.updateOnboardingSurvey` | `SettingsClient.updateOnboardingSurvey` |
| `GET /admin/analytics` | Fetch usage/analytics summaries. | `analyticsController.getAnalytics` | `AnalyticsClient.getAnalytics` |
| `GET /admin/usage` | Token/cost usage trends. | `usageController.getUsage` | `UsageClient.getUsage` |

### Keeping Docs & Clients in Sync

1. Update this file whenever new routes are added or shape changes so AI assistants always know where to look.
2. Update `frontend/src/lib/api/contracts.ts` to describe the request/response types for the new route.
3. Ensure the typed client under `frontend/src/lib/api/*.client.ts` exposes the new endpoint and surface it through `frontend/src/lib/api/index.ts`.

With this workflow the written contract (docs), typed contract map (code), and runtime client stay aligned.

## Testing Index

# Testing Index

Use this index to pick the right level of coverage before shipping. Everything under `docs/testing/` is grouped by how it is exercised—either scripted/automated or manual scenario playbooks.

## Automated / Script-backed Suites

| Doc | What it covers | Primary Commands |
| --- | --- | --- |
| `FRONTEND_TEST_GUIDE.md` | How to run the Playwright/Next lint suites for the dashboard. | `npm run lint`, `npx playwright test` |
| `TEST_WORKFLOW_GENERATION_E2E.md` | End-to-end workflow generation with webhook callbacks (both Node & Bash harnesses plus optional manual flow). | `node scripts/test-workflow-generation-e2e.js`, `./scripts/test-workflow-generation-e2e.sh` |
| `TEST_STEP_RERUN.md` | Verifies that rerunning a single job step only reprocesses that step while preserving context. | `python3 scripts/testing/test-step-rerun.py <job_id> <step_index>` |
| `TEST_WEBHOOK_ARTIFACTS.md` | Programmatic verification that webhook payloads include the expected artifact bundle. | `./scripts/test-webhook-artifacts-now.sh` |
| `VERIFY_WEBHOOK_ARTIFACTS.md` | Smoke test to confirm artifacts land in S3 + webhook recipients after deploys. | `./verify-webhook-artifacts.sh` (see doc for env vars) |
| `TEST_QUICK_EDIT.md` | Scripted quick-edit regression that exercises `/admin/jobs/:id/quick-edit-step`. | `node scripts/test-quick-edit.js` |

> **Tip:** `scripts/test-e2e.sh` chains the most common API + UI happy-paths. Run it before every release along with the domain-specific suites above.

## Manual Scenario Guides

These walkthroughs document how to validate UI/UX changes and production behaviours that are hard to automate today.

| Doc | Scenario |
| --- | --- |
| `TESTING_GUIDE.md` | High-level checklist for smoke-testing the entire product (auth, workflows, forms, deliveries). |
| `MANUAL_TESTING_GUIDE.md` | Markdown/HTML artifact rendering checks inside the artifacts dashboard. |
| `MOBILE_TESTING.md` | Steps to validate responsive/mobile workflows end-to-end. |
| `COMPLETE_MOBILE_TESTING_SUMMARY.md` | Snapshot of the last full mobile regression results. |
| `WORKFLOW_EDIT_MOBILE_TEST.md` | Detailed reproduction steps for editing workflows on mobile viewports. |
| `SETTINGS_PAGE_TEST_SUMMARY.md` | What to verify on the Settings tab after UI or API adjustments. |
| `QUICK_EDIT_TESTING.md` | Manual drill for confirm-in-place edits (pairs nicely with the quick edit script). |
| `TEST_IMAGE_IMPROVEMENTS_SUMMARY.md` | Results + checklist for the image artifact improvments rollout. |
| `WEBHOOK_TESTING.md` | Manual webhook validation flow (headers, retries, payload shape). |
| `TEST_WEBHOOK_ARTIFACTS.md` (manual section) | Contains observation checklist when co-monitoring webhook artifacts with the script. |

### How to Use

1. **Pick the domain** you touched (workflows, forms, jobs, templates, notifications, settings).
2. **Run the matching automated suite** from the first table.
3. **Spot-check the manual guide** that mirrors your change (UI behaviour, webhook payloads, device-specific layouts).
4. Record results directly inside the Markdown files or link them in the PR description for auditability.

When you add a new test playbook, drop the `.md` file into this directory and extend the relevant table here so the rest of the team—and AI assistants—can find it.

## Plan - artifact-preview-improvements-2465069d.plan.md

<!-- 2465069d-b8e4-4a02-bc42-bb3810d9cbd9 00d331b9-03b6-4b18-9832-b9dd13678403 -->
# Artifact Preview Improvements

## Changes

1. **Extract HTML from markdown code blocks** (`frontend/src/components/artifacts/PreviewRenderer.tsx`)

- When fetching HTML content, check if it's wrapped in ```html ``` code blocks
- Extract only the content between the markers before setting it as HTML content
- Handle both ```html and ``` markers

2. **Default preview to open** (`frontend/src/components/jobs/ArtifactPreview.tsx`)

- Change `showPreview` initial state from `false` to `true` (line 24)
- This makes artifact previews visible by default when viewing execution steps

3. **Truncate long URLs** (`frontend/src/components/jobs/StepInputOutput.tsx`)

- Truncate image URLs displayed in the image section (line 261)
- Truncate artifact URLs in the artifact display section (line 295)
- Show a reasonable length (e.g., first 50 chars + "...") with full URL in title attribute for hover

4. **Show generated images in preview** (`frontend/src/components/jobs/ExecutionSteps.tsx` and new component)

- Create an `ImagePreview` component similar to `ArtifactPreview` that displays images with preview open by default
- Show generated images (from `image_urls` or `imageArtifacts`) in the same area as artifacts, outside the Input & Output section
- Display images in a preview format that's visible by default, similar to how artifacts are now shown
- This allows users to quickly see generated images without expanding the Input & Output section

### To-dos

- [ ] Add HTML extraction logic in PreviewRenderer.tsx to extract content from ```html ``` code blocks
- [ ] Change ArtifactPreview.tsx to default showPreview to true instead of false
- [ ] Truncate long URLs in StepInputOutput.tsx for both image URLs and artifact URLs

## Context Pack - backend

# Backend API Context Pack

Use this when you are touching the TypeScript/Fastify Lambda API that lives under `backend/api`.

## Purpose & Highlights

- Multi-tenant REST API that backs the dashboard, public form endpoints, and asynchronous workflow generation hooks.
- Organized by domain under `src/domains/*` so controllers, services, routes, and handlers stay co-located.
- Typed API contracts live in `frontend/src/lib/api/contracts.ts` and are documented in `docs/contracts/README.md`.

## Layout Cheat Sheet

| Path | What lives there |
| --- | --- |
| `src/domains/workflows` | Workflows controllers/services/routes + workflow generation handlers. |
| `src/domains/forms` | Form CRUD + AI CSS helpers and public form routes. |
| `src/domains/impersonation` | Impersonation controller + routes. |
| `src/routes` | Registry (`routes/index.ts`) plus shared routers/middleware. |
| `src/utils` | Shared Dynamo, auth, validation, logging utilities (still referenced via `@utils/*`). |
| `src/services` | Cross-domain helpers that have not moved into `domains` yet (auth, analytics, usage, templates, etc.). |

## Commands

```bash
# Install deps (once)
cd backend/api
npm install

# Type-check + build (tsc + tsc-alias rewrite)
npm run build

# Local watch + lambda-style dev server
npm run dev     # build + node server-local.js
npm run watch   # tsc -w + tsc-alias -w

# Jest/unit tests (where available)
npm test
```

## Implementation Notes

- Path aliases (`@domains/*`, `@utils/*`, etc.) are defined in `backend/api/tsconfig.json`. `tsc-alias` rewrites them for the emitted JS bundle.
- Workflow + form services were moved under `src/domains/*/services`—import them via `@domains/<domain>/services/...`.
- The Lambda entry point (`src/index.ts`) registers routes and imports `handleWorkflowGenerationJob` from the workflow domain.
- When adding new endpoints, update:
  1. Domain route + controller.
  2. `docs/contracts/README.md`.
  3. `frontend/src/lib/api/contracts.ts` plus the matching client in `frontend/src/lib/api/*.client.ts`.

## Debug Tips

- For route wiring issues, set breakpoints/logs inside `src/routes/router.ts` and the domain `register*Routes` function.
- Dynamo table names are sourced from `src/utils/env.ts`; use `logger` from `@utils/logger` so logs surface in CloudWatch.
- Use `npm run dev` (Fastify local server) for HTTP testing or execute `node test-local.ts` with crafted events to simulate API Gateway payloads.

## Context Pack - infrastructure

# Infrastructure Context Pack

For work inside `infrastructure/` (AWS CDK TypeScript stacks).

## Scope

- Provisions API Gateway, Lambda API, DynamoDB tables, Step Functions, worker Lambda, S3 buckets, Cognito pools, alarms, and Shared VPC components.
- CDK app entry: `infrastructure/bin/app.ts`.
- Stacks live under `infrastructure/lib/*.ts` (api, auth, compute, database, monitoring, storage, worker, stepfunctions, utils).

## Commands

```bash
cd infrastructure
npm install

# Bootstrap if the account/region is new
cdk bootstrap

# See pending changes
cdk diff leadmagnet-compute

# Deploy individual stacks
cdk deploy leadmagnet-api
cdk deploy leadmagnet-compute

# Destroy when finished
cdk destroy leadmagnet-*    # confirm prompts
```

## Tips

- Runtime config shared between stacks lives under `lib/config/constants.ts`.
- Step Functions definitions are TypeScript files in `lib/stepfunctions/*`; update both `.ts` and generated `.d.ts`/`.js` outputs if you transpile.
- When adding environment variables, thread them through `lib/utils/environment-helpers.ts` so both API and worker stacks stay in sync.
- All stacks use the same context values defined in `infrastructure/cdk.json`; update them if you change account/region names.
- Keep an eye on IAM diff noise—`cdk diff --security-only` is helpful during reviews.

## Context Pack - worker

# Worker Context Pack

Reference this pack when editing the Python worker that processes workflow jobs (`backend/worker`).

## Role in the System

- Executes workflow steps produced by the API (AI research, AI generation, HTML rendering, delivery).
- Runs as both a Lambda function (`lambda_handler.py`) and as a local script (`worker.py` / `processor.py`).
- Shares service modules under `backend/worker/services/*` (step processors, OpenAI client, tool builders, retry/error helpers).

## Directory Landmarks

| Path | Notes |
| --- | --- |
| `worker.py` | Local entry point that can poll jobs manually. |
| `lambda_handler.py` | AWS Lambda entry that Step Functions invokes. |
| `processor.py` | Main orchestration loop (loads job, executes steps, persists output). |
| `services/` | Individual helpers (AI step processor, tool builder, webhook step service, etc.). |
| `utils/` | Shared helpers (content detection, decimal utils, error utils). |
| `tests/` (`test_*.py`) | Unit and integration tests for image handling, webhook steps, retries, etc. |

## Commands

```bash
cd backend/worker
python3 -m venv .venv && source .venv/bin/activate  # optional virtualenv
pip install -r requirements.txt

# Run the full pytest suite (includes image + webhook tests)
pytest

# Execute worker locally against a job payload
python worker.py --job-id <job_id>

# Invoke Lambda handler locally with a JSON event
python -c "from lambda_handler import lambda_handler; lambda_handler({'job_id': '...'}, None)"
```

## Implementation Notes

- Secrets (OpenAI keys, bucket names) are pulled from environment variables—see `services/openai_client.py` and `services/dependency_resolver.py`.
- Image-heavy tests rely on fixtures in `tests/`; keep them fast by guarding remote calls with `pytest.mark.skipif`.
- When coordinating with the API, make sure job schema changes are reflected in both `services/workflow_orchestrator.py` and the corresponding TypeScript DTOs.
- The worker honours `workflowGenerationJobService` contracts; any new step types should expose a processor under `services/*` and be wired in `workflow_orchestrator.py`.

## Context Pack - workflows

# Workflows Context Pack

This pack is for changes that impact the workflow authoring experience end-to-end (API, worker behaviour, frontend editors, and validation).

## Domain Overview

| Layer | Critical Files |
| --- | --- |
| Backend | `backend/api/src/domains/workflows/*` (controllers, services, routes, job handlers) |
| Frontend | `frontend/src/app/dashboard/workflows/*`, `frontend/src/hooks/api/useWorkflows.ts`, `frontend/src/lib/api/workflows.client.ts` |
| Worker | `backend/worker/services/workflow_orchestrator.py`, `backend/worker/services/ai_step_processor.py` |
| Docs | `docs/contracts/README.md` (REST contract), `docs/testing/TEST_WORKFLOW_GENERATION_E2E.md` (end-to-end validation) |

## Typical Tasks

1. **Add or tweak a workflow endpoint**
   - Update the relevant controller/service under `src/domains/workflows`.
   - Register or modify the route in `src/domains/workflows/routes/workflowRoutes.ts`.
   - Extend the typed contract (`frontend/src/lib/api/contracts.ts`) and the `WorkflowsClient`.
   - Wire the UI via the workflow hooks or React query endpoints.

2. **Adjust workflow generation logic**
   - API layer: `workflowGenerationJobService.ts` and `workflowGenerationService.ts`.
   - Worker layer: `workflow_orchestrator.py` plus any new service modules.
   - Update docs/tests: `docs/testing/TEST_WORKFLOW_GENERATION_E2E.md`.

3. **Update validation/config parsing**
   - Use helpers in `services/workflow/workflowConfigSupport.ts`.
   - Update validators or step normalization logic under `workflowValidationController.ts`.
   - Mirror shape changes in `frontend/src/types/workflow.ts`.

## Commands & Checks

```bash
# Backend API
cd backend/api
npm run build   # or npm run dev for watch mode

# Worker (if job semantics change)
cd backend/worker
pytest

# Frontend sanity checks
cd frontend
npm run lint
npx playwright test --grep workflows
```

## Testing Matrix

- **Automated**: run `node scripts/test-workflow-generation-e2e.js` (or the `.sh` variant) to ensure webhook-driven generation still works.
- **Manual UI**: follow `docs/testing/TESTING_GUIDE.md` (workflow section) plus `docs/testing/WORKFLOW_EDIT_MOBILE_TEST.md` if you touched responsive layouts.
- **Step reruns**: `docs/testing/TEST_STEP_RERUN.md` + `python3 scripts/testing/test-step-rerun.py <job_id> <step_index>`.

## Gotchas

- Keep path aliases in mind when touching imports: use `@domains/workflows/...` inside the API to avoid brittle relative paths.
- Workflow JSON schemas are shared with the frontend through `@/types`. Always update those types when the backend shape changes to prevent runtime errors.
- Public forms auto-create forms whenever a workflow is created; make sure `formService` changes align with workflow defaults.
